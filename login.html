<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday For You!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="shortcut icon" type="image/png" href="/favicon.PNG" />
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css">
    <style>
        :root {
            /* Dark Neumorphic Palette */
            --bg-color: #2c2f36;
            --shadow-dark: #202227;
            --shadow-light: #383c45;
            --text-color: #d1d5db;
            --text-light: #8a91a0;
            --primary: #5a7dff;
            --primary-dark: #4a6fe0;
            --success: #28a745;
            --error: #dc3545;
            --found: #ffc107; /* Warna untuk kata yang ditemukan */
            --transition-smooth: all 0.3s ease-in-out;
            --border-radius-main: 24px;
            --border-radius-inner: 15px;
        }

        /* Base Styles & Utilities */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            background: var(--bg-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
            color: var(--text-color);
        }
        body.no-scroll { overflow: hidden; }
        body.scroll-allowed { overflow: auto; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.95); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes wobble-gift { 0%, 100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } }
        @keyframes fadeInCard-anim { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        /* General Button Style */
        .btn { padding: 16px; background: var(--bg-color); border: none; border-radius: var(--border-radius-inner); color: var(--primary); font-size: 1.05rem; font-weight: 600; cursor: pointer; width: 100%; transition: var(--transition-smooth); box-shadow: 8px 8px 18px var(--shadow-dark), -8px -8px 18px var(--shadow-light); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); color: var(--primary-dark); }
        .btn:active:not(:disabled) { transform: translateY(0px); box-shadow: inset 7px 7px 15px var(--shadow-dark), inset -7px -7px 15px var(--shadow-light); }
        .btn:disabled { cursor: not-allowed; opacity: 0.7; }
        
        /* --- Error Page --- */
        .error-page { display: none; text-align: center; color: var(--text-light); animation: fadeIn 0.5s ease-out; z-index: 20; }
        .error-page .error-icon { font-size: 5rem; color: var(--primary); margin-bottom: 20px; }
        .error-page h1 { font-size: 2.2rem; color: var(--text-color); margin-bottom: 10px; }
        .error-page p { font-size: 1.1rem; }

        /* --- Login Container --- */
        .login-container { width: 100%; max-width: 400px; display: none; }
        .login-box { background: var(--bg-color); border-radius: var(--border-radius-main); box-shadow: 12px 12px 24px var(--shadow-dark), -12px -12px 24px var(--shadow-light); padding: 40px; text-align: center; animation: fadeIn 0.8s ease forwards; }
        .login-header { margin-bottom: 35px; }
        .login-icon { width: 85px; height: 85px; background: var(--bg-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; box-shadow: 8px 8px 18px var(--shadow-dark), -8px -8px 18px var(--shadow-light); }
        .login-icon i { font-size: 40px; color: var(--primary); }
        h1 { font-size: 2rem; color: var(--text-color); margin-bottom: 8px; }
        .login-box p { color: var(--text-light); font-size: 1rem; }
        .input-group { position: relative; margin-bottom: 25px; }
        .input-group .icon { position: absolute; left: 22px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: 16px; transition: all 0.3s ease; pointer-events: none; }
        .input-group input { width: 100%; padding: 18px 22px 18px 55px; background: var(--bg-color); border: none; border-radius: var(--border-radius-inner); color: var(--text-color); font-size: 1rem; box-shadow: inset 7px 7px 15px var(--shadow-dark), inset -7px -7px 15px var(--shadow-light); transition: var(--transition-smooth); -webkit-user-select: text; user-select: text; }
        .input-group input:focus { outline: none; box-shadow: inset 9px 9px 18px var(--shadow-dark), inset -9px -9px 18px var(--shadow-light), 0 0 0 2px var(--primary); }
        .input-group input::placeholder { color: var(--text-light); }
        .input-group:focus-within .icon { color: var(--primary); }
        #togglePassword { position: absolute; right: 22px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-light); pointer-events: auto; z-index: 5; }
        #togglePassword:hover { color: var(--primary); }
        .login-box .btn { margin-top: 10px; }

        /* --- Game Container (Added) --- */
        .game-container { display: none; flex-direction: column; align-items: center; text-align: center; width: 100%; max-width: 500px; padding: 20px; animation: fadeIn 1s ease-out; user-select: none; }
        .game-container h1 { font-size: clamp(1.8rem, 5vw, 2.5rem); margin-bottom: 5px; }
        .game-container p { font-size: clamp(0.9rem, 3vw, 1rem); color: var(--text-light); margin-bottom: 25px; }
        #word-search-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; background: var(--bg-color); padding: 15px; border-radius: var(--border-radius-inner); box-shadow: 12px 12px 24px var(--shadow-dark), -12px -12px 24px var(--shadow-light); margin-bottom: 25px; }
        .letter-cell { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 600; background-color: var(--bg-color); border-radius: 8px; box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); cursor: pointer; transition: all 0.2s ease; color: var(--text-light); text-transform: uppercase; }
        .letter-cell.selected { background-color: var(--primary); color: white; box-shadow: none; }
        .letter-cell.found { background-color: var(--found); color: #333; font-weight: 700; box-shadow: none; }
        #words-to-find-container { display: flex; gap: 20px; justify-content: center; }
        .word-item { font-size: 1.2rem; font-weight: 500; color: var(--text-light); position: relative; transition: color 0.3s ease; text-transform: uppercase; }
        .word-item.found { color: var(--text-color); }
        .word-item.found::after { content: ''; position: absolute; left: -5%; top: 55%; width: 110%; height: 3px; background-color: var(--found); transform: rotate(-5deg); animation: fadeIn 0.3s; }

        /* --- Birthday Page --- */
        .birthday-page-container { display: none; flex-direction: column; align-items: center; padding-top: 8vh; padding-bottom: 8vh; width: 100%; max-width: 1000px; animation: fadeIn 1s ease-out forwards; overflow-y: auto; height: 95vh; }
        .birthday-content { width: 100%; text-align: center; z-index: 10; padding: 0 15px; }
        .main-title { font-family: 'Pacifico', cursive; font-size: clamp(3rem, 10vw, 6rem); line-height: 1.2; color: var(--text-color); text-shadow: 0 0 20px rgba(255,255,255,0.1); animation: fadeInDown 1s ease-out forwards; margin-bottom: 40px; }
        .main-title span { color: var(--primary); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; padding-bottom: 30px; }
        .message-card { background: var(--bg-color); border-radius: var(--border-radius-main); box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light); padding: 30px; color: var(--text-color); opacity: 0; filter: blur(5px); transform: perspective(800px) rotateY(var(--initial-rotation, -20deg)) scale(0.9); transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.8s ease-out, opacity 0.6s ease-out; }
        .message-card.is-visible { opacity: 1; filter: blur(0); transform: perspective(800px) rotateY(0) scale(1); }
        .card-icon { font-size: 2.5rem; margin-bottom: 15px; color: var(--primary); }
        .card-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 10px; }
        .card-text { font-size: 1rem; line-height: 1.6; font-weight: 300; color: var(--text-light); white-space: pre-wrap; }
        .gift-section-card { margin-top: 30px; display: flex; flex-direction: column; align-items: center; background: var(--bg-color); border-radius: var(--border-radius-main); box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light); padding: 30px; color: var(--text-color); opacity: 0; filter: blur(5px); transform: perspective(800px) rotateY(var(--initial-rotation, 0deg)) scale(0.9); transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.8s ease-out, opacity 0.6s ease-out; }
        .gift-section-card.is-visible { opacity: 1; filter: blur(0); transform: perspective(800px) rotateY(0) scale(1); }
        .gift-btn { margin-top: 20px; color: var(--success); width: auto; padding: 15px 40px; font-size: 1.2rem; min-width: 200px; }
        .gift-btn:hover { color: #32c256; }

        /* --- Modals & Other Styles --- */
        .feedback-modal, .gift-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 2000; justify-content: center; align-items: center; padding: 15px; animation: fadeIn 0.3s ease-out forwards; }
        .feedback-content { background: var(--bg-color); border-radius: var(--border-radius-main); box-shadow: 12px 12px 24px var(--shadow-dark), -12px -12px 24px var(--shadow-light); padding: 40px; text-align: center; width: 90%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }
        .loader { margin: 0 auto; border: 6px solid var(--shadow-light); border-top: 6px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        .gift-box { width: 250px; height: 250px; cursor: pointer; animation: wobble-gift 2s ease-in-out infinite alternate; }
        .gift-box img { width: 100%; height: 100%; object-fit: contain; }
        .gift-card { display: none; background: var(--bg-color); border-radius: var(--border-radius-main); padding: 30px; text-align: center; width: 100%; max-width: 320px; box-shadow: 12px 12px 24px var(--shadow-dark), -12px -12px 24px var(--shadow-light); animation: fadeInCard-anim 0.5s ease-out forwards; color: var(--text-color); }
        #qrCodeImg { width: 180px; height: 180px; margin: 15px auto; border-radius: var(--border-radius-inner); background: var(--bg-color); padding: 8px; box-shadow: inset 5px 5px 15px var(--shadow-dark), inset -5px -5px 15px var(--shadow-light); object-fit: contain; }
        .music-toggle { position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; z-index: 1000; padding: 0; border-radius: 50%; }
        
        /* CSS untuk Salju Warna-warni */
        .snow-particle { position: fixed; top: -10px; border-radius: 50%; z-index: 5; pointer-events: none; }

        .swal2-popup { background-color: var(--bg-color) !important; border-radius: var(--border-radius-main) !important; color: var(--text-color) !important; box-shadow: 12px 12px 24px var(--shadow-dark), -12px -12px 24px var(--shadow-light) !important; }
        .swal2-title { color: var(--text-color) !important; } .swal2-html-container { color: var(--text-light) !important; }
        .swal2-confirm { background-color: var(--primary) !important; color: white !important; } .swal2-confirm:hover { background-color: var(--primary-dark) !important; }
        @media (max-width: 480px) {
            #word-search-grid { grid-template-columns: repeat(10, 1fr); gap: 4px; padding: 10px; }
            .letter-cell { width: 28px; height: 28px; font-size: 0.9rem; border-radius: 6px; }
        }
    </style>
</head>
<body>
    <audio id="background-music" loop><source src="mayfa.mp3"></source></audio>
    <audio id="word-found-sound" src="https://assets.codepen.io/217233/chime.mp3"></audio>
    <audio id="confetti-sound" src="https://assets.codepen.io/217233/confetti.mp3"></audio>
    <button id="musicToggleBtn" class="btn music-toggle"><i class="fas fa-volume-off"></i></button>

    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <div class="login-icon"><i class="fas fa-birthday-cake"></i></div>
                <h1>Hai, Kamu! ✨</h1>
                <p>Silakan login untuk melihat kejutan spesialmu.</p>
            </div>
            <div class="input-group">
                <i class="fas fa-user icon"></i>
                <input type="text" id="username" placeholder="Username">
            </div>
            <div class="input-group">
                <i class="fas fa-lock icon"></i>
                <input type="password" id="password" placeholder="••••••••">
                <i class="fas fa-eye-slash" id="togglePassword"></i>
            </div>
            <button class="btn" onclick="login()"><i class="fas fa-right-to-bracket"></i> Masuk</button>
        </div>
    </div>
    
    <div class="game-container" id="gameContainer">
        <h1>Temukan Kata Tersembunyi</h1>
        <p>Tahan & seret untuk menghubungkan huruf dan temukan 3 kata spesial!</p>
        <div id="word-search-grid"></div>
        <div id="words-to-find-container"></div>
    </div>

    <div class="birthday-page-container" id="birthdayPage">
        <div class="birthday-content">
            <h1 class="main-title">Selamat Ulang Tahun, <span></span>!</h1>
            <div class="card-grid">
                <div class="message-card"><i class="fas fa-calendar-check card-icon"></i><h2 class="card-title">Level Baru Terbuka!</h2><p class="card-text" id="ageDisplay"></p></div>
                <div class="message-card"><i class="fas fa-star card-icon"></i><h2 class="card-title">Harapan Terbaik</h2><p class="card-text" id="bestWishesText"></p></div>
                <div class="message-card"><i class="fas fa-heart card-icon"></i><h2 class="card-title">Teruntuk kamu di hari yang istimewa</h2><p class="card-text" id="stayStrongQuoteText"></p></div>
            </div>
            <div class="gift-section-card message-card" id="giftSectionCard">
                <h2 class="card-title">waitt, there's a gift for you...</h2>
                <button class="btn gift-btn" onclick="openGift()"><i class="fas fa-gift"></i> claim ur gift!</button>
            </div>
        </div>
    </div>

    <div class="error-page" id="errorPage">
        <div class="error-icon"><i class="fas fa-link-slash"></i></div>
        <h1 id="errorTitle">Halaman Tidak Ditemukan</h1>
        <p id="errorMessage">Pastikan link yang Anda masukkan sudah benar dan lengkap.</p>
    </div>
    <div class="gift-modal" id="giftModal">
        <div class="gift-box" onclick="openCard()"><img src="IMG_1316.png" alt="Gift Box" style="width: 100%; height: 100%; object-fit: contain;"></div>
        <div class="gift-card" id="giftCard">
            <h2 style="font-weight: 600;">Hai, <span id="giftCardName"></span>!</h2>
            <p>Scan QR ini untuk klaim hadiahmu!</p>
            <img id="qrCodeImg" alt="QR Code Hadiah">
            <p id="qrMessageText"></p>
        </div>
    </div>
    <div class="feedback-modal" id="feedbackModal">
        <div class="feedback-content">
            <div class="loader" id="feedbackLoader"></div>
            <h2 id="feedbackTitle"></h2><p id="feedbackMessage"></p>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>
    <script>
        // --- CONFIG & GLOBAL VARIABLES ---
        const firebaseConfig = { apiKey: "GANTI_DENGAN_API_KEY_ANDA", authDomain: "mayfa-fa284.firebaseapp.com", databaseURL: "https://mayfa-fa284-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let pageData = {};
        let particleInterval;
        let snowfallInterval; // Variabel untuk interval salju

        // --- DOM ELEMENTS ---
        const loginContainer = document.getElementById("loginContainer"), 
              gameContainer = document.getElementById("gameContainer"),
              birthdayPage = document.getElementById("birthdayPage"), 
              errorPage = document.getElementById("errorPage"), 
              giftModal = document.getElementById("giftModal"), 
              giftBox = document.querySelector(".gift-box"), 
              giftCard = document.getElementById("giftCard"), 
              backgroundMusic = document.getElementById("background-music"),
              confettiSound = document.getElementById('confetti-sound'), 
              togglePassword = document.getElementById("togglePassword"), 
              passwordInput = document.getElementById("password"),
              musicToggleBtn = document.getElementById('musicToggleBtn');
        
        // --- LOGIN & DATA FETCHING ---
        function showErrorPage(title, message) { loginContainer.style.display = 'none'; birthdayPage.style.display = 'none'; gameContainer.style.display = 'none'; document.getElementById('errorTitle').textContent = title; document.getElementById('errorMessage').textContent = message; errorPage.style.display = 'block'; document.body.classList.remove("no-scroll"); }
        function showFeedback(state, title, message = '') { const modal = document.getElementById('feedbackModal'); document.getElementById('feedbackLoader').style.display = (state === 'loading' ? 'block' : 'none'); document.getElementById('feedbackTitle').textContent = title; document.getElementById('feedbackMessage').textContent = message; modal.style.display = 'flex'; }
        function hideFeedback() { document.getElementById('feedbackModal').style.display = 'none'; }

        async function login() {
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            const urlParams = new URLSearchParams(window.location.search);
            const pageId = urlParams.get('id');
            if (!username || !password) { Swal.fire({ icon: 'warning', title: 'Input Tidak Lengkap', text: 'Mohon isi Username dan Password.' }); return; }
            if (!pageId) { showErrorPage("Link Tidak Valid", "ID halaman tidak ditemukan di URL."); return; }
            await performGuestLogin(username, password, pageId);
        }

        async function performGuestLogin(username, password, pageId) {
            showFeedback('loading', 'Memverifikasi Data...', 'Mohon tunggu sebentar ya.');
            try {
                const snapshot = await database.ref(`birthday_pages/${pageId}`).once('value');
                const data = snapshot.val();
                if (data && data.guestUser === username && data.guestPass === password) {
                    pageData = data;
                    await Swal.fire({ icon: 'success', title: 'Login Berhasil!', text: 'Selamat datang, ayo main game dulu!', toast: true, position: 'top-end', showConfirmButton: false, timer: 2500, timerProgressBar: true, });
                    
                    loginContainer.style.animation = 'fadeOut 0.5s ease-out forwards';
                    loginContainer.addEventListener('animationend', () => {
                        loginContainer.style.display = "none";
                        gameContainer.style.display = 'flex';
                        initWordSearch();
                    }, { once: true });
                    
                    hideFeedback();
                    return true;
                } else {
                    Swal.fire({ icon: 'error', title: 'Login Gagal', text: 'Username atau password salah. Coba lagi ya!' });
                    hideFeedback(); return false;
                }
            } catch (error) {
                console.error("Error during guest login:", error);
                Swal.fire({ icon: 'error', title: 'Terjadi Kesalahan', text: 'Gagal login. Silakan coba lagi nanti.' });
                hideFeedback(); return false;
            }
        }
        
        // --- GAME LOGIC (Unchanged) ---
        const gridElement = document.getElementById('word-search-grid');
        const wordsContainer = document.getElementById('words-to-find-container');
        const wordFoundSound = document.getElementById('word-found-sound');
        const gridSize = 10;
        let wordsToFind = [], grid = [], isDragging = false, selection = [], foundWords = [];

        function initWordSearch() {
            wordsToFind = [ (pageData.puzzleWord1 || 'ULTAH').toUpperCase(), (pageData.puzzleWord2 || 'KADO').toUpperCase(), (pageData.puzzleWord3 || 'DOA').toUpperCase() ];
            foundWords = [];
            grid = Array(gridSize).fill(null).map(() => Array(gridSize).fill(null));
            const directions = ['horizontal', 'vertical', 'diagonal-down', 'diagonal-up'];
            wordsToFind.forEach(word => {
                let placed = false;
                while (!placed) {
                    const dir = directions[Math.floor(Math.random() * directions.length)];
                    const r = Math.floor(Math.random() * gridSize);
                    const c = Math.floor(Math.random() * gridSize);
                    if (canPlaceWord(word, r, c, dir)) {
                        placeWord(word, r, c, dir);
                        placed = true;
                    }
                }
            });
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let r = 0; r < gridSize; r++) { for (let c = 0; c < gridSize; c++) { if (grid[r][c] === null) { grid[r][c] = alphabet[Math.floor(Math.random() * alphabet.length)]; } } }
            renderGrid();
            renderWordList();
            addGridEventListeners();
        }

        function canPlaceWord(word, r, c, dir) {
            for (let i = 0; i < word.length; i++) {
                let newR = r, newC = c;
                if (dir === 'horizontal') newC += i;
                else if (dir === 'vertical') newR += i;
                else if (dir === 'diagonal-down') { newR += i; newC += i; }
                else if (dir === 'diagonal-up') { newR -= i; newC += i; }
                if (newR < 0 || newR >= gridSize || newC < 0 || newC >= gridSize) return false;
                if (grid[newR][newC] !== null && grid[newR][newC] !== word[i]) return false;
            }
            return true;
        }

        function placeWord(word, r, c, dir) {
            for (let i = 0; i < word.length; i++) {
                if (dir === 'horizontal') grid[r][c + i] = word[i];
                else if (dir === 'vertical') grid[r + i][c] = word[i];
                else if (dir === 'diagonal-down') grid[r + i][c + i] = word[i];
                else if (dir === 'diagonal-up') grid[r - i][c + i] = word[i];
            }
        }

        function renderGrid() {
            gridElement.innerHTML = '';
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'letter-cell';
                    cell.textContent = grid[r][c];
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    gridElement.appendChild(cell);
                }
            }
        }
        
        function renderWordList() {
            wordsContainer.innerHTML = '';
            wordsToFind.forEach(word => {
                const wordItem = document.createElement('span');
                wordItem.className = 'word-item';
                wordItem.id = `word-${word}`;
                wordItem.textContent = word;
                wordsContainer.appendChild(wordItem);
            });
        }
        
        function addGridEventListeners() {
            gridElement.removeEventListener('mousedown', startDrag);
            document.removeEventListener('mouseup', endDrag);
            gridElement.removeEventListener('touchstart', startDrag);
            document.removeEventListener('touchend', endDrag);
            gridElement.addEventListener('mousedown', startDrag);
            document.addEventListener('mouseup', endDrag);
            gridElement.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }

        function getCellFromEvent(e) {
            let target;
            if (e.touches && e.touches.length > 0) { target = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY); } 
            else if (e.changedTouches && e.changedTouches.length > 0) { target = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY); } 
            else { target = e.target; }
            return target && target.closest('.letter-cell');
        }

        function startDrag(e) {
            e.preventDefault();
            const startCell = getCellFromEvent(e);
            if (!startCell) return;
            isDragging = true;
            selection = [startCell];
            startCell.classList.add('selected');
            gridElement.addEventListener('mouseover', duringDrag);
            gridElement.addEventListener('touchmove', duringDrag, { passive: false });
        }
        
        function duringDrag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const currentCell = getCellFromEvent(e);
            if (currentCell && !selection.includes(currentCell)) {
                selection.forEach(c => c.classList.remove('selected'));
                highlightPath(selection[0], currentCell);
            }
        }

        function highlightPath(startCell, endCell) {
            selection = [];
            const start = { r: parseInt(startCell.dataset.row), c: parseInt(startCell.dataset.col) };
            const end = { r: parseInt(endCell.dataset.row), c: parseInt(endCell.dataset.col) };
            const dr = end.r - start.r; const dc = end.c - start.c;
            if (dr !== 0 && dc !== 0 && Math.abs(dr) !== Math.abs(dc)) { selection = [startCell]; startCell.classList.add('selected'); return; }
            const stepR = Math.sign(dr); const stepC = Math.sign(dc); const steps = Math.max(Math.abs(dr), Math.abs(dc));
            for(let i = 0; i <= steps; i++) {
                const r = start.r + i * stepR; const c = start.c + i * stepC;
                const cell = gridElement.querySelector(`[data-row='${r}'][data-col='${c}']`);
                if (cell) { cell.classList.add('selected'); selection.push(cell); }
            }
        }

        function endDrag(e) {
            if (!isDragging) return;
            isDragging = false;
            gridElement.removeEventListener('mouseover', duringDrag);
            gridElement.removeEventListener('touchmove', duringDrag);
            const selectedWord = selection.map(cell => cell.textContent).join('');
            const reversedWord = selectedWord.split('').reverse().join('');
            wordsToFind.forEach(word => {
                if (!foundWords.includes(word) && (selectedWord === word || reversedWord === word)) {
                    foundWords.push(word);
                    selection.forEach(cell => { cell.classList.remove('selected'); cell.classList.add('found'); });
                    document.getElementById(`word-${word}`).classList.add('found');
                    wordFoundSound.play().catch(e => console.log("Sound play prevented"));
                }
            });
            if (selection.length > 0 && !selection[0].classList.contains('found')) { selection.forEach(cell => cell.classList.remove('selected')); }
            if (foundWords.length === wordsToFind.length) { setTimeout(completeGame, 500); }
        }
        
        async function completeGame() {
            await Swal.fire({ icon: 'success', title: 'Kamu Hebat!', html: 'Semua kata berhasil ditemukan.<br>Siap melihat kejutanmu?', confirmButtonText: 'Lihat Kejutan <i class="fas fa-arrow-right"></i>', allowOutsideClick: false, allowEscapeKey: false, });
            gameContainer.style.animation = 'fadeOut 0.5s ease-out forwards';
            gameContainer.addEventListener('animationend', () => { gameContainer.style.display = 'none'; showBirthdayPage(); }, { once: true });
        }
        
        // --- BIRTHDAY PAGE & VISUAL EFFECTS LOGIC (Unchanged) ---
        function showBirthdayPage() {
            birthdayPage.style.display = "flex";
            document.body.classList.add("scroll-allowed");
            document.querySelector(".main-title span").textContent = pageData.birthdayName || 'Kamu';
            if (pageData.birthDate) { calculateAndDisplayAge(pageData.birthDate); } else { document.getElementById("ageDisplay").innerText = "Tanggal lahir belum diatur."; }
            document.getElementById('bestWishesText').textContent = pageData.bestWishes || 'Semoga setiap langkahmu dipenuhi kebahagiaan dan kesuksesan.';
            document.getElementById('stayStrongQuoteText').textContent = pageData.stayStrongQuote || '"Teruslah kuat dan berjuang, kamu lebih hebat dari yang kamu kira."';
            initScrollAnimations();
            startSnowfallEffect(); // Memulai efek salju
        }

        function calculateAndDisplayAge(birthDate) {
            const birthDateObj = new Date(birthDate + 'T00:00:00');
            const today = new Date();
            let years = today.getFullYear() - birthDateObj.getFullYear();
            let months = today.getMonth() - birthDateObj.getMonth();
            let days = today.getDate() - birthDateObj.getDate();
            if (days < 0) { months--; days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); }
            if (months < 0) { years--; months += 12; }
            document.getElementById("ageDisplay").innerText = `Selamat! Kamu berhasil menyelesaikan misi selama ${years} tahun, ${months} bulan, dan ${days} hari untuk sampai di level ini. Semoga chapter barumu makin seru!`;
        }

        function initScrollAnimations() { const cards = document.querySelectorAll('.message-card, .gift-section-card'); const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('is-visible'); } else { entry.target.classList.remove('is-visible'); } }); }, { root: null, rootMargin: '0px', threshold: 0.1 }); cards.forEach((card, index) => { card.style.setProperty('--initial-rotation', index % 2 === 0 ? '-15deg' : '15deg'); card.style.transitionDelay = `${index * 150}ms`; observer.observe(card); }); }
        
        function openGift() { 
            stopSnowfallEffect(); // Menghentikan salju saat modal hadiah dibuka
            giftModal.style.display = "flex"; 
            document.body.classList.remove("scroll-allowed"); 
            document.body.style.overflow = "hidden"; 
        }
        
        function openCard() { 
            giftBox.style.display = "none"; 
            giftCard.style.display = "block"; 
            document.getElementById("giftCardName").textContent = pageData.birthdayName || 'Teman'; 
            const qrImg = document.getElementById("qrCodeImg"); 
            qrImg.src = pageData.qrImageUrl || `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Default-QR`; 
            document.getElementById('qrMessageText').textContent = pageData.qrMessage || 'Semoga bermanfaat ya!'; 
            startFullScreenConfetti();
        }

        function closeGiftModal() { 
            giftModal.style.display = "none"; 
            document.body.classList.add("scroll-allowed"); 
            clearInterval(particleInterval);
            setTimeout(() => { 
                giftCard.style.display = "none"; 
                giftBox.style.display = "block"; 
            }, 500); 
        }
        
        function startSnowfallEffect() {
            if (snowfallInterval) clearInterval(snowfallInterval);
            const colors = ['#FF6F61', '#FFD700', '#6A5ACD', '#7FFF00', '#00CED1', '#FF1493'];
            snowfallInterval = setInterval(() => {
                const particle = document.createElement('div');
                particle.classList.add('snow-particle');
                const size = Math.random() * 8 + 3;
                particle.style.cssText = `left: ${Math.random() * 100}vw; width: ${size}px; height: ${size}px; background-color: ${colors[Math.floor(Math.random() * colors.length)]}; opacity: ${Math.random() * 0.8 + 0.4};`;
                document.body.appendChild(particle);
                particle.animate([
                    { transform: 'translateY(0) translateX(0)', opacity: 0.8 },
                    { transform: `translateY(110vh) translateX(${Math.random() * 60 - 30}px)`, opacity: 0 }
                ], { duration: 6000 + Math.random() * 8000, easing: 'linear' }).onfinish = () => particle.remove();
            }, 150);
        }

        function stopSnowfallEffect() {
            clearInterval(snowfallInterval);
            document.querySelectorAll('.snow-particle').forEach(el => el.remove());
        }

        function startFullScreenConfetti() { 
            confettiSound.play().catch(e => console.log("Sound play prevented"));
            const duration = 15 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 2100 };
            const colors = ["#FF6F61", "#FFD700", "#6A5ACD", "#7FFF00", "#00CED1", "#FF1493", "#FFFFFF", "#E0EFFF"];
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            if (particleInterval) clearInterval(particleInterval);
            particleInterval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(particleInterval);
                const particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }, colors: colors }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }, colors: colors }));
            }, 250);
        }
        
        // --- EVENT LISTENERS ---
        togglePassword.addEventListener("click", function() { const type = passwordInput.getAttribute("type") === "password" ? "text" : "password"; passwordInput.setAttribute("type", type); this.classList.toggle("fa-eye"); this.classList.toggle("fa-eye-slash"); });
        musicToggleBtn.addEventListener('click', () => { const icon = musicToggleBtn.querySelector('i'); if (backgroundMusic.paused) { backgroundMusic.play().catch(e => console.error("Music play failed:", e)); icon.classList.remove('fa-volume-off'); icon.classList.add('fa-volume-high'); } else { backgroundMusic.pause(); icon.classList.remove('fa-volume-high'); icon.classList.add('fa-volume-off'); } });
        giftModal.addEventListener("click", e => { if (e.target === giftModal) closeGiftModal(); });

        // --- INITIAL LOAD LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.body.classList.add("no-scroll");
            const urlParams = new URLSearchParams(window.location.search);
            const pageId = urlParams.get('id');
            const authParam = urlParams.get('auth');

            // --- FIX: Logic untuk Akses Otomatis via URL ---
            if (!pageId) {
                showErrorPage("Halaman Tidak Ditemukan", "Pastikan link yang Anda masukkan sudah benar dan lengkap (termasuk ID).");
                return;
            }

            try {
                // Pre-fetch data untuk memeriksa apakah halaman ada
                const snapshot = await database.ref('birthday_pages/' + pageId).once('value');
                if (!snapshot.exists() || !snapshot.val().birthdayName) {
                    showErrorPage("Konten Belum Tersedia", "Halaman ini sedang disiapkan. Coba lagi nanti ya!");
                    return;
                }
                
                // Jika ada parameter 'auth', coba login otomatis
                if (authParam) {
                    let decoded;
                    try {
                        decoded = JSON.parse(atob(authParam));
                    } catch (e) {
                        console.error("Gagal decode auth parameter:", e);
                        Swal.fire({ icon: 'error', title: 'Link Tidak Valid', text: 'Link akses otomatis rusak. Silakan login manual.' });
                        loginContainer.style.display = 'block'; // Tampilkan login manual jika decode gagal
                        return; // Hentikan eksekusi lebih lanjut
                    }

                    const loginSuccess = await performGuestLogin(decoded.user, decoded.pass, pageId);
                    if (!loginSuccess) {
                        // Jika login otomatis gagal (misal pass sudah diganti), beri tahu pengguna dan tampilkan form
                        Swal.fire({ icon: 'info', title: 'Akses Otomatis Gagal', text: 'Kredensial tidak cocok. Silakan login manual.' });
                        loginContainer.style.display = 'block';
                    }
                } else {
                    // Jika tidak ada parameter 'auth', tampilkan form login manual
                    loginContainer.style.display = 'block';
                }
            } catch (error) {
                console.error("Error saat memuat halaman:", error);
                showErrorPage("Terjadi Kesalahan", "Gagal memuat data halaman. Coba refresh halaman.");
            }
            // --- END FIX ---
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
</body>
</html>
